{% extends "base.html" %}
{% load humanize %}
{% load display_tags %}
{% load static %}

{% block add_styles %}
    {{ block.super }}
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.25/css/dataTables.bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/1.7.1/css/buttons.bootstrap.min.css">
    <style>
        .tier-1 { background-color: #d9534f; color: white; font-weight: bold; padding: 4px 8px; border-radius: 3px; }
        .tier-2 { background-color: #f0ad4e; color: white; font-weight: bold; padding: 4px 8px; border-radius: 3px; }
        .tier-3 { background-color: #5bc0de; color: white; font-weight: bold; padding: 4px 8px; border-radius: 3px; }
        .tier-4 { background-color: #5cb85c; color: white; font-weight: bold; padding: 4px 8px; border-radius: 3px; }
        .tier-archived { background-color: #777; color: white; font-weight: bold; padding: 4px 8px; border-radius: 3px; }
        .signal-count { font-size: 18px; font-weight: bold; color: #337ab7; }
        .dataTables_wrapper { margin-top: 20px; }
    </style>
{% endblock %}

{% block content %}
    {{ block.super }}

    <div class="panel panel-default">
        <div class="panel-heading tight">
            <div class="clearfix">
                <h3 class="has-filters">
                    Repository Dashboard
                    <span class="badge">{{ products.count }} Repositories</span>
                    <div class="dropdown pull-right">
                        <button class="btn btn-primary" onclick="window.location.href='{% url 'sync_all_repositories' %}'">
                            <i class="fa-solid fa-sync"></i> Sync All
                        </button>
                    </div>
                </h3>
            </div>
        </div>

        <div class="panel-body">
            <!-- Summary Statistics -->
            <div class="row">
                <div class="col-md-3">
                    <div class="panel panel-default text-center" style="background-color: #d9534f; color: white;">
                        <div class="panel-body">
                            <h2>{{ tier_stats.very_high|default:0 }}</h2>
                            <p>Tier 1 (Very High)</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="panel panel-default text-center" style="background-color: #f0ad4e; color: white;">
                        <div class="panel-body">
                            <h2>{{ tier_stats.high|default:0 }}</h2>
                            <p>Tier 2 (High)</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="panel panel-default text-center" style="background-color: #5bc0de; color: white;">
                        <div class="panel-body">
                            <h2>{{ tier_stats.medium|default:0 }}</h2>
                            <p>Tier 3 (Medium)</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="panel panel-default text-center" style="background-color: #5cb85c; color: white;">
                        <div class="panel-body">
                            <h2>{{ tier_stats.low|default:0 }}</h2>
                            <p>Tier 4 (Low)</p>
                        </div>
                    </div>
                </div>
            </div>

            <hr>

            <!-- Repository Table -->
            <table id="repositories" class="table table-striped table-bordered" style="width:100%">
                <thead>
                    <tr>
                        <th>Repository</th>
                        <th>Tier</th>
                        <th>Language</th>
                        <th>Signals</th>
                        <th>Last Commit</th>
                        <th>Contributors</th>
                        <th>Findings</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in products %}
                    <tr>
                        <td>
                            <a href="{% url 'view_product' product.id %}">{{ product.name }}</a>
                            {% if product.github_url %}
                            <br><small><a href="{{ product.github_url }}" target="_blank"><i class="fa-brands fa-github"></i> GitHub</a></small>
                            {% endif %}
                        </td>
                        <td>
                            <span class="tier-{{ product.business_criticality|slugify }}">
                                {{ product.get_business_criticality_display|upper }}
                            </span>
                        </td>
                        <td>{{ product.primary_language|default:"N/A" }}</td>
                        <td class="signal-count">
                            {% with total_signals=0 %}
                            {% if product.has_dockerfile %}{% with total_signals=total_signals|add:1 %}{% endwith %}{% endif %}
                            {% if product.has_kubernetes_config %}{% with total_signals=total_signals|add:1 %}{% endwith %}{% endif %}
                            {% if product.has_ci_cd %}{% with total_signals=total_signals|add:1 %}{% endwith %}{% endif %}
                            {% if product.has_environments %}{% with total_signals=total_signals|add:1 %}{% endwith %}{% endif %}
                            {% if product.has_releases %}{% with total_signals=total_signals|add:1 %}{% endwith %}{% endif %}
                            {% if product.has_tests %}{% with total_signals=total_signals|add:1 %}{% endwith %}{% endif %}
                            {{ total_signals }}/36
                            {% endwith %}
                        </td>
                        <td data-order="{{ product.last_commit_date|date:'U'|default:'0' }}">
                            {% if product.last_commit_date %}
                                {{ product.last_commit_date|naturaltime }}
                                <br><small>({{ product.days_since_last_commit }} days ago)</small>
                            {% else %}
                                Never
                            {% endif %}
                        </td>
                        <td>{{ product.active_contributors_90d|default:0 }}</td>
                        <td>
                            <a href="{% url 'view_product' product.id %}#findings">
                                {{ product.findings_count|default:0 }}
                            </a>
                        </td>
                        <td>
                            <a href="{% url 'view_product_repository' product.id %}" class="btn btn-sm btn-info">
                                <i class="fa-solid fa-eye"></i> View
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
{% endblock %}

{% block postscript %}
    {{ block.super }}
    <script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.25/js/dataTables.bootstrap.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.7.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.7.1/js/buttons.bootstrap.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.7.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.7.1/js/buttons.print.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>

    <script>
        $(document).ready(function() {
            $('#repositories').DataTable({
                dom: 'Bfrtip',
                buttons: [
                    'copy', 'excel', 'pdf', 'print'
                ],
                order: [[1, 'asc'], [4, 'desc']], // Order by tier, then last commit
                pageLength: 50,
                lengthMenu: [[25, 50, 100, -1], [25, 50, 100, "All"]],
                columnDefs: [
                    { orderable: false, targets: [7] } // Disable sorting on Actions column
                ]
            });
        });
    </script>
{% endblock %}
